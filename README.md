# Библиотека для интеграции WhatsApp и 1С
Здесь содержится конфигурация, выгруженная через конфигуратор 1С в формате xml файлов. Используя конфигурацию можно отправлять и получать сообщения к себе на WhatsApp, проверять наличие Whatsapp, получать контакты, чаты, историю переписок с собеседниками.  Интеграция с WhatsApp сделана через REST сервис [sdkwa.pro](https://sdkwa.pro)
Ключевые отличия от других подобных сервисов: 

1. Поддерживается подключение к Whatsapp как через QR код, так и через СМС / звонок 
2. Имеет полностью безлимитный и бесплатный тариф для нескольких аккаунтов. 

![`Отправка сообщения`](media/Login.png)


## Что дают разные способы авторизации

Ключевым моментом  в работе API является используемый метод авторизации.  Самый популярный – это интеграция  с Whatsapp путем  сканирования QR кода в связанных устройствах мобильного приложения. Для этого:

* Из API делается запрос в Whatsapp, который получает QR код
* Полученный QR код отображается в интерфейсе
* Пользователь из мобильного приложения Whatsapp на вкладке "Связанные устройства" сканирует QR код, телефон авторизуется, после чего можно использовать API

Но раньше на слуху был и другой способ авторизации  - это SMS-верификация номера телефона.  Данный способ отошел на второй план вместе с прекращением поддержки библиотеки Yowsup в 2021 г., но сейчас наблюдаются предпосылки его второго рождения.  Для этого:

* Из API делается запрос который побуждает Whatsapp отправить код регистрации на телефон в виде СМС или звонка (настраиваемый параметр)
* Пользователь получает код регистрации и вводит его в интерфейс программы
* Из API делается запрос, который передает введенный код регистрации в Whatsapp, телефон авторизуется, после чего можно использовать API
Независимо от выбранного способа авторизации, практически все функции Whatsapp, за исключением специфических для мобильного приложения (например, геолокации) будут работать одинаково, а значит API не будет отличаться.


| Критерий      | Авторизация по QR коду  | Авторизация по СМС / звонку |
| ------------- | ----------------------- | --------------------------- |
| `Легкость авторизации`    | QR-коды легко получить с сервера Whatsapp. Нет таймаутов и задержек | Есть жесткие ограничения на количество и задержки запросов кодов авторизации с одного номера. Желательно вводить код с первого раза |
| `Баны` | Есть проблема сброса авторизации по QR коду. | Нет проблемы со сбросом авторизации по QR коду |
| `Поддержка нескольких устройств` | Можно работать на одном телефоне как через API с функцией чат-бота, так и в пользовательском режиме | Невозможно использовать на одном номере телефона одновременно Whatsapp приложение и API сервис. |
| `Стабильность технологии` | Технология давно используется | Редко используется           |
| `Процент доставки сообщений` | Не всегда доставляются отправленные сообщения, т.к. отправка идет не с основного устройства | Теоретически процент доставки сообщений выше, т.к. отправка идет с основного устройства |
| `Автономность` | Требует установленное приложения Whatsapp на телефоне. | Не требует установленного приложения Whatsapp. |
| `Привязка к телефону` | Нельзя зарегистрировать много номеров в качестве API используя один телефон | Можно зарегистрировать любое количество номеров в качестве API, используя один лишь физический телефон |

## Требования
* Для запуска обработки нужна Платформа 1С не ниже версии 8.3.10.
* Для загрузки исходников нужно Платформа 1С не ниже версии 8.3.16.1063

Перед началом использования необходимо пройти регистрацию в сервисе, чтобы получить IdInstance и ApiTokenInstance.  Это можно сделать через личный кабинет, либо через встроенный в обработку помощник

## Сценарии работы

## Подключение к сервису basis-api
![`Авторизация`](media/Auth.png)
1. [Скачать обработку](https://github.com/Yard-Team/whatsapp-api-client-1c/releases) в формате epf
2. Через кнопку Помощник пройти авторизацию, либо сделать через сайт [sdkwa.pro](https://sdkwa.pro/). Получить ``API Token`` и ``ID Instance``
4. После выполнения в основной форме обработки нажать ``Проверить подключение``. Статус должен изменится на "Authorized"

## Отправка сообщения
![`Отправка сообщения`](media/Sending.png)
1. Перейти на вкладку ``Отправка сообщений`` и указать телефон получателя и текст соообщения
2. Нажать кнопку ``Отправить текст``

## Получение сообщения
![`Получение сообщения`](media/Receiving.png)
1. Перейти на вкладку ``Получение сообщений``
2. Нажать на кнопку ``Получить сообщенние``. Поле ``Тело сообщения`` заполнится данными в формате JSON. Если нет сообщений для получения, то обработка будет ждать 5 секунд для получения сообщения.

## Использование обработки в собственных конфигурациях

Обработка имеет программный интерфейс по [стандартам разработки 1С](https://its.1c.ru/db/v8std). Ее можно встроить в конфигурацию и вызывать АПИ на сервере через создание объекта. Документация по всем методам находится по [ссылке](https://sdkwa.pro/ru/docs/api/). Примеры использования:


1. Авторизация в Whatsapp по QR коду
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
ОтветQR = АПИ.ПолучитьQRКод();
Если ОтветQR.type = "qrCode" Тогда
	МакетQRHTML = Обработки.SDKWA.ПолучитьМакет("QRМакет").ТекущаяОбласть.Текст;
	// Реквизит типа Строка связанный с элементом формы с видом "Поле HTML документа"
	РеквизитQR = СтрЗаменить(МакетQRHTML, "%QR_DATA%", ОтветQR.message);
КонецЕсли;
```
2. Отправить текстовое сообщение
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Ответ = АПИ.ОтправитьТекст(790012345673442, "Hello"); 
Сообщить(Ответ.idMessage)
```
3. Отправить изображение по ссылке
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Ответ = АПИ.ОтправитьВидеоАудиоИзображениеДокументПоURL(
    790012345673442, 
    "https://cdn-icons-png.flaticon.com/512/124/124034.png",
	"wa.png",
	"wa"
);
Сообщить(Ответ.idMessage)
```
4. Отправить zip документ через загрузку
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Ответ = АПИ.ОтправитьВидеоАудиоИзображениеДокумент(
	790012345673442, 
	"D:\temp.zip",
	"temp.zip");
Сообщить(Ответ.idMessage)
```
5. Отправить геолокацию
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Ответ = АПИ.ОтправитьГеолокацию(
	790012345673442, 
	"I'm here",
	"Tretyakovskaya Galereya", 
	"55.740930", 
	"37.620508"
);
Сообщить(Ответ.idMessage)
```
6. Отправить контакт
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Ответ = АПИ.ОтправитьКонтакт(
	7900123456858, 
	7900123456859,
	"First name",
	"Middle name",
	"Last name",
	"Company"
);
Сообщить(Ответ.idMessage)
```
7. Получить входящее текстовое сообщение
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
// Вызов ждет 5 сек для входящего сообщения. 
ОтветСообщение = АПИ.ПолучитьУведомление();
Если ОтветСообщение <> Неопределено 
	И ОтветСообщение.body.typeWebhook = "incomingMessageReceived" 
	И ОтветСообщение.body.messageData.typeMessage = "textMessage" Тогда
	
	Сообщить("Тест сообщения: " + ОтветСообщение.body.messageData.textMessageData.textMessage) 
	
КонецЕсли;
АПИ.УдалитьУведомление(ОтветСообщение.receiptId);
```
8. Получить входящий файл
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
// Вызов ждет 5 сек для входящего сообщения 
ОтветСообщение = АПИ.ПолучитьУведомление();
Если ОтветСообщение <> Неопределено 
	И ОтветСообщение.body.typeWebhook = "incomingMessageReceived" 
	И ОтветСообщение.body.messageData.typeMessage = "documentMessage" Тогда
		
	Сообщить("Ссылка на файл: " + ОтветСообщение.body.messageData.fileMessageData.downloadUrl) 
	
КонецЕсли;
АПИ.УдалитьУведомление(ОтветСообщение.receiptId);
```
9. Получить историю сообщений чата
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
МассивСообщений = АПИ.ПолучитьИсториюСообщенийЧата(7900123456858, 100);
```
10. Получить контакты
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
МассивКонтактов = АПИ.ПолучитьКонтакты();
Для каждого Контакт Из МассивКонтактов Цикл
	Сообщить("name: " + Контакт.name);
	Сообщить("id: " + Контакт.id);
	Сообщить("type: " + Контакт.type);
КонецЦикла;
```
11. Получить информацию о контакте
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
ИнфоКонтакта = АПИ.ПолучитьИнфоКонтакта(7900123456858);
Сообщить("avatar", ИнфоКонтакта.avatar);
Сообщить("chatId", ИнфоКонтакта.chatId);
Сообщить("name", ИнфоКонтакта.name);
Сообщить("isMute", ИнфоКонтакта.isMute);
Сообщить("isDisappearing", ИнфоКонтакта.isDisappearing);
```
12. Проверить наличие Whatsapp
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Ответ = АПИ.ПроверитьНаличиеWhatsApp(7900123456858);
Сообщить("existsWhatsapp=" + Ответ.existsWhatsapp); 
```
13. Отметить чат прочитанным
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Ответ = АПИ.ОтметитьЧатПрочитанным(7900123456858);
Сообщить("setRead=" + Ответ.setRead);
```
14. Работа с группой
```bsl
АПИ = Обработки.SDKWA.Создать();
АПИ.IdInstance = "ИД ИНСТАНСА";
АПИ.ApiToken = "АПИ ТОКЕН";
Массив = Новый Массив;
Массив.Добавить(7900123456859);
ОтветГруппа = АПИ.СоздатьГруппу("Моя тестовая группа", Массив);
ИдГруппы = ОтветГруппа.chatId;
ИнфоГруппы = АПИ.ПолучитьИнформациюОГруппе(ИдГруппы);
ИнфоГруппы = АПИ.ПолучитьИнформациюОГруппе(ИдГруппы);
Сообщить("groupInviteLink=" + ИнфоГруппы.groupInviteLink);
АПИ.ДобавитьУчастникаВГруппу(ИдГруппы, 7900123456851);
АПИ.ОтправитьТекстВГруппу(ИдГруппы, "Привет всем!");
```

